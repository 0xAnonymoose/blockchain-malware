import puppeteer from 'puppeteer';
import {setTimeout} from "timers/promises";

let re = new RegExp('https://bscscan.com/address/0x[0-9a-fA-F]{40}', 'g');

async function searchBing(query) {

  let results = [];

  async function onResponse(r) {
    let url = await r.url();
    if (url.startsWith('https://www.bing.com/search')) {
      let text = await r.text();
      let hits = text.match(re);
      //console.log(hits);
      results = [...results, ...hits]
    }   
  }
  
  console.log('Launching chrome...');
  const browser = await puppeteer.launch();
  console.log('Opening new page...');
  const page = await browser.newPage();
  page.on('response', onResponse );
  page.on('console', async(r)=>{ console.log('Console:', await r.text() ); } );
  await page.setDefaultNavigationTimeout(20000); 

  let url = "https://www.bing.com/search?q=%22"+query+"%22+site%3Abscscan.com";
  
  console.log('Waiting for page to load...');
  try {
    await page.goto(url);
  } catch(err) {
    console.log('page load error', err);
    await browser.close();
    return {error: err}
  }
  
  let lastResults = null;
  
  while (lastResults != results.length) {
  
     await setTimeout(2000);
  
     try { 
        await page.$$eval("a",
                  anchors=>anchors.filter(
                           anchor=>anchor.title
                                         .includes("Next page"))[0].click());
     } catch (e) {
        break;
     }

     console.log('Got',results.length,'results');                               
  }
      
  await browser.close();
  
  return results;

}

const argv = process.argv;

(async()=>{

if (argv.length < 3) {
  console.log('Usage: node searchBscScanCode.mjs <keyword>');
} else {

let results = await searchBing(argv[2]);
let uniqueItems = [...new Set(results.map((x)=>{return x.toLowerCase();}))]
console.log('Got',uniqueItems.length,'unique results');
for (let url of uniqueItems) { console.log(url.replace('https://bscscan.com/address/','')); }

}

})();
