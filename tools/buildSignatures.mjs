import glob from 'glob';
import path from 'path';
import { parse } from 'yaml'
import { writeFileSync, readFileSync } from 'fs';

const sample_root = '../samples/';
const output_file = 'blockchain-malware-signatures.json';

let sigs = { version: 1, revision: 1, sigName: 'blockchain-malware' };
let count = 0;

glob(sample_root+'**/malware.yaml', {}, (err, files)=> {
if (err) { console.error(err); }
else {
  for (let f of files) {
    let folder = path.dirname( path.resolve(f) );
    let malware = parse( readFileSync(folder +'/malware.yaml', 'utf-8') );   
    let { malwareName, malwareTags, signatures } = malware;
    count += malware.signatures.length;
    
    console.log('loaded',malwareName);
    
    sigs[malwareName] = { malwareName, malwareTags, signatures };
  }
  
  writeFileSync( output_file, JSON.stringify(sigs));
  console.log(output_file, 'created from', Object.keys(sigs).length - 3,'malwares with', count,'signatures');
  
}
} );
